name: Deploy

on:
  push:
    branches: [main]
    paths:
      - 'app/**'
      - 'backend/writeflow-sam-app/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches: [main]
    paths:
      - 'app/**'
      - 'backend/writeflow-sam-app/**'

env:
  NODE_VERSION: '22'
  AWS_REGION: us-east-1
  SAM_STACK_NAME: writeflow-sam-app

jobs:
  # ============================================
  # Frontend Jobs
  # ============================================
  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: app/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install
        working-directory: app

      - name: Run linter
        run: pnpm lint
        working-directory: app

      - name: Type check
        run: pnpm exec tsc --noEmit
        working-directory: app

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: lint-frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: app/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install
        working-directory: app

      - name: Build
        run: pnpm build
        working-directory: app
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL_DEV }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: app/dist
          retention-days: 1

  deploy-frontend-preview:
    name: Deploy Frontend (Preview)
    runs-on: ubuntu-latest
    needs: build-frontend
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: app/dist

      - name: Deploy to Cloudflare Pages (Preview)
        uses: cloudflare/wrangler-action@v3
        id: deploy
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy app/dist --project-name=writeflow --branch=${{ github.head_ref }} --commit-dirty=true --no-bundle

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Deploy Preview Ready!\n\n**Frontend:** ${{ steps.deploy.outputs.deployment-url }}\n\n*Commit: \`${{ github.sha }}\`*`
            })

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: build-frontend
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      deployments: write
    environment:
      name: production
      url: ${{ steps.deploy.outputs.deployment-url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: app/dist

      - name: Debug - List downloaded files
        run: |
          echo "Contents of app/dist:"
          ls -la app/dist/

      - name: Create Pages project if not exists
        run: |
          PROJECT_NAME="writeflow"
          API_URL="https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects"

          # Check if project exists
          RESPONSE=$(curl -s -X GET "$API_URL/$PROJECT_NAME" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}")

          if echo "$RESPONSE" | jq -e '.success == true' > /dev/null 2>&1; then
            echo "✅ Project $PROJECT_NAME already exists"
          else
            echo "Creating project $PROJECT_NAME..."
            curl -s -X POST "$API_URL" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data "{\"name\":\"$PROJECT_NAME\",\"production_branch\":\"main\"}"
            echo "✅ Project created"
          fi

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        id: deploy
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy app/dist --project-name=writeflow --branch=main --commit-dirty=true --no-bundle

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Frontend URL:** ${{ steps.deploy.outputs.deployment-url }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Backend Jobs (AWS SAM)
  # ============================================
  validate-backend:
    name: Validate Backend
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup AWS SAM
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate SAM template
        run: sam validate --lint
        working-directory: backend/writeflow-sam-app

  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: validate-backend
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install esbuild
        run: npm install -g esbuild

      - name: Setup AWS SAM
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build SAM application
        run: sam build
        working-directory: backend/writeflow-sam-app

      - name: Verify build output
        run: |
          echo "Contents of .aws-sam:"
          ls -la backend/writeflow-sam-app/.aws-sam/
          echo "Contents of .aws-sam/build:"
          ls -la backend/writeflow-sam-app/.aws-sam/build/ || echo "No build directory"

      - name: Upload SAM build artifact
        uses: actions/upload-artifact@v4
        with:
          name: sam-build
          path: |
            backend/writeflow-sam-app/.aws-sam/build/
            backend/writeflow-sam-app/.aws-sam/build.toml
          if-no-files-found: error
          retention-days: 1

  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: build-backend
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      id-token: write
      contents: read
    environment:
      name: backend-dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup AWS SAM
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download SAM build artifact
        uses: actions/download-artifact@v4
        with:
          name: sam-build
          path: backend/writeflow-sam-app/.aws-sam

      - name: Deploy SAM application
        run: |
          sam deploy \
            --stack-name ${{ env.SAM_STACK_NAME }} \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --parameter-overrides Environment=dev \
            --capabilities CAPABILITY_IAM \
            --resolve-s3
        working-directory: backend/writeflow-sam-app

      - name: Get API Gateway URL
        id: get-api-url
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.SAM_STACK_NAME }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiEndpoint`].OutputValue' \
            --output text)
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "## Backend Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** $API_URL" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # API Docs Jobs
  # ============================================
  build-api-docs:
    name: Build API Docs
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm install
        working-directory: backend/writeflow-sam-app

      - name: Build docs
        run: npm run docs:build
        working-directory: backend/writeflow-sam-app

      - name: Debug - List built files
        run: |
          echo "Contents of docs-dist:"
          ls -la backend/writeflow-sam-app/docs-dist/

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: api-docs-build
          path: backend/writeflow-sam-app/docs-dist
          retention-days: 1

  deploy-api-docs:
    name: Deploy API Docs
    runs-on: ubuntu-latest
    needs: build-api-docs
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      deployments: write
    environment:
      name: api-docs
      url: ${{ steps.deploy.outputs.deployment-url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download docs artifact
        uses: actions/download-artifact@v4
        with:
          name: api-docs-build
          path: docs-dist

      - name: Debug - List downloaded files
        run: |
          echo "Contents of docs-dist:"
          ls -la docs-dist/

      - name: Create Pages project if not exists
        run: |
          PROJECT_NAME="writeflow-api-docs"
          API_URL="https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/pages/projects"

          # Check if project exists
          RESPONSE=$(curl -s -X GET "$API_URL/$PROJECT_NAME" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}")

          if echo "$RESPONSE" | jq -e '.success == true' > /dev/null 2>&1; then
            echo "✅ Project $PROJECT_NAME already exists"
          else
            echo "Creating project $PROJECT_NAME..."
            curl -s -X POST "$API_URL" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              --data "{\"name\":\"$PROJECT_NAME\",\"production_branch\":\"main\"}"
            echo "✅ Project created"
          fi

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        id: deploy
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy docs-dist --project-name=writeflow-api-docs --branch=main --commit-dirty=true --no-bundle

      - name: Deployment Summary
        run: |
          echo "## API Docs Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Swagger UI:** ${{ steps.deploy.outputs.deployment-url }}" >> $GITHUB_STEP_SUMMARY
